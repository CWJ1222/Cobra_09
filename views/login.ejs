<!DOCTYPE html>
<html lang="ko">
  <head>
    <%-include('include/head')%>
    <title><%#= title %></title>
    <!-- (todo) ë‚˜ì¤‘ì— public/css ë¶„ë¦¬ ì˜ˆì • -->
    <style>
      main {
        display: flex;
        justify-content: center;
        flex-direction: column;
        align-items: center;
      }

      /* ë¡œê·¸ì¸ ì¹´ë“œ ë ˆì´ì•„ì›ƒ */
      .loginCard {
        width: 340px;
        padding: 50px 0;
        text-align: center;
      }

      .loginCard h1 {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 20px;
      }

      .loginCard p{
        margin-bottom: 20px;
      }

      .loginCard form input {
        width: 100%;
        padding: 8px;
        margin: 10px 0;
        
        border-radius: 6px;
        font-size: 14px;
      }

      /* ë¡œê·¸ì¸ ì…ë ¥ì°½ */
      .inputWrapper {
        position: relative;
      }

      .inputWrapper input {
        width: 100%;
        height: 50px;
        padding: 10px 40px 10px 10px;
        border: 1px solid var(--color-secondary);
        font-size: 16px;
        outline: none;
        transition: all 0.4s ease-in-out;
      }

      .inputWrapper label {
        position: absolute;
        top: 50%;
        left: 10px;
        transform: translateY(50%);
        color: transparent;
        font-size: 16px;
        pointer-events: none;
        transition: all 0.3s ease;
        pointer-events: none;
      }

      /* ë¡œê·¸ì¸ ì…ë ¥ì°½ í™œì„±í™” ìƒíƒœ */
      .inputWrapper input:focus::placeholder{
        color: transparent;
      }
      .inputWrapper input:focus + label,
      .inputWrapper input:not(:placeholder-shown) + label {
        top: 5px; /* ì…ë ¥ì°½ ì¢Œì¸¡ ìƒë‹¨ìœ¼ë¡œ ì´ë™ */
        left: 10px;
        font-size: 12px;
        color: var(--color-text-sub);
      }

      /* ë¡œê·¸ì¸ ì—ëŸ¬ ë©”ì‹œì§€ */
      #error {
        display: none;
        background-color: #fafafa;
        padding: 20px;
        text-align: start;
        font-size: 14px;
        color: var(--color-error)
      }

      /* ë¹„ë°€ë²ˆí˜¸ ë³´ê¸° ìˆ¨ê¸°ê¸° */
      #toggleBtn{
        position: absolute;
        top: 40%;
        right: 10px;
        cursor: pointer;
        color: var(--color-secondary);
      }
      #toggleBtn::before{
        content: '\f070'; /* ëˆˆ ê°ê¹€ */
        font-family: fontAwesome;
      }
      #toggleBtn.show::before{
        content: '\f06e'; /* ëˆˆ ëœ¸! */
        font-family: fontAwesome;
      }

      /* ë¡œê·¸ì¸ ë²„íŠ¼ */
      .loginBtn {
        width: 100%;
        padding: 12px;
        background-color: var(--color-primary-light);
        color: var(--color-primary);
        border: none;
        font-size: 14px;
        margin-bottom: 10px;
        transition: all 0.4s ease-in-out;
      }
      .loginBtn:hover{
        filter: brightness(0.9)
      }
      
      .loginBtn.email{
        margin-top: 20px;
      }
      /* OAuth ë²„íŠ¼ */
      .loginBtn.kakao{
        background-color: #ffe812;
        color: #3c1e1e;
        cursor: pointer;
        border-radius: 9px;
      }

      .loginBtn.naver {
        background-color: #1ec800;
        color: white;
      }

      /* í•˜ë‹¨ ë§í¬ */
      .loginFooter {
        font-size: 14px;
        margin-top: 40px;
        color: var(--color-text);
        position: relative; 
      }

      .loginFooter::before{
        content: '';
        position: absolute;
        top: -20px;
        left: 0;;
        width: 100%;
        height: 1px;
        background-color: var(--color-secondary);
      }

      .loginFooter a {
        color: var(--color-text);
        text-decoration: none;
      }

      .loginFooter a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <!-- í—¤ë” -->
    <%- include('include/header') %>

    <!-- ë³¸ë¬¸ ì˜ì—­ (ë¡œê·¸ì¸) -->
    <main class="max-container">
      
      <!-- ë¡œê·¸ì¸ ì¹´ë“œ -->
      <div class="loginCard">
        <h1>ë¡œê·¸ì¸</h1>
        
        <!-- ë¡œê·¸ì¸ í¼ -->
        <form id="loginForm" name="loginForm">
          <div class="inputWrapper">

            <!-- urlì „ë‹¬ì‹œí‚¤ê¸° -->
            <input type="hidden" name="redirectUrl" value="<%= redirectUrl %>" />

            <input
            type="text"
            name="id"
            placeholder="ì´ë©”ì¼"
            aria-label="ì´ë©”ì¼"
            required />
            <label for="userId">ì´ë©”ì¼</label>
          </div>
          <div class="inputWrapper">
            <input
            type="password"
            id="password"
            name="pw"
            placeholder="ë¹„ë°€ë²ˆí˜¸"
            aira-label="ë¹„ë°€ë²ˆí˜¸"
            required/>
            <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
            <span id="toggleBtn"></span>
          </div>
          <div id="error" class="errorMsg"></div>
          <button type="button" class="loginBtn email" id="login-button">
            ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸í•˜ê¸°
          </button>
          
        </form>

        <!-- OAuth ë¡œê·¸ì¸ ë²„íŠ¼ -->
         <!-- (todo) ì™¼ìª½ì— ì•„ì´ì½˜ ë„£ê¸° -->
        <div class="loginBtn kakao">
          <a href="/auth/kakao">
            ì¹´ì¹´ì˜¤ë¡œ ì‹œì‘í•˜ê¸°
          </a>
        </div>
        <!-- <button class="loginBtn naver">ë„¤ì´ë²„ë¡œ ì‹œì‘í•˜ê¸°</button> -->

         <!-- í•˜ë‹¨ ë§í¬ -->
         <div class="loginFooter">
          <a href="/">ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a> |
          <a id="signup-button" >íšŒì›ê°€ì…</a>
        </div>
      </div>

      </form>
    </main>

    <!-- footer -->
    <%- include('include/footer', { title: 'test' })%>
  </body>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const loginButton = document.getElementById('login-button');
      const signupButton = document.getElementById('signup-button');

      loginButton.addEventListener('click', login);

      signupButton.addEventListener('click', () => {
        window.location.href = '/member/signup';
      });
    });

    // ë¡œê·¸ì¸ ì²˜ë¦¬
    async function login(e) {
      e.preventDefault();

      const form = document.forms['loginForm'];
      const userId = form.id.value.trim();
      const password = form.pw.value.trim();

      // ì—ëŸ¬ ë©”ì‹œì§€ ì˜ì—­ ì´ˆê¸°í™”
      const errorMsg = document.getElementById('error');
      errorMsg.style.display = 'none'; //ì´ˆê¸°í™” ì‹œ ìˆ¨ê¹€
      errorMsg.innerText = '';
      
      // ìœ íš¨ì„± ê²€ì‚¬
      // (todo) ìœ íš¨ì„± ê²€ì‚¬ ì¶”ê°€: ì´ë©”ì¼ í˜•ì‹/ ì˜ë¬¸,ìˆ«ì,íŠ¹ìˆ˜ë¬¸ì í¬í•¨ 8ì ì´ìƒ
      if (!userId || !password) {
        errorMsg.innerText =
          'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš” ğŸ¥¹';
          errorMsg.style.display = 'block'; 
        return;
      }

      // ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡
      const data = { userId, password };
      console.log('ë¡œê·¸ì¸ ë°ì´í„°', data);

      try {
        const res = await axios.post('/auth', data);

        // ë¡œê·¸ì¸ ì„±ê³µ
        if (res.status === 200 && res.data.isLogin) {
          alert(`${res.data.nickname}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`);
          window.location.href = res.data.redirectUrl || '/';
        }
      } catch (err) {
        // ìƒíƒœ ì½”ë“œ ê¸°ë°˜ fe ë©”ì‹œì§€ ì²˜ë¦¬
        if (err.response) {
          const { status, data } = err.response;

          if (status === 401) {
            // ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜ ë˜ëŠ” íšŒì› ì •ë³´ ì—†ìŒ
            errorMsg.textContent = data.message || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
          } else if (status === 404) {
            // íšŒì› ì •ë³´ ì—†ìŒ
            errorMsg.textContent = 'íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íšŒì›ê°€ì…ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.';
          } else if (status === 500) {
            // ì„œë²„ ì˜¤ë¥˜
            errorMsg.textContent = 'ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
          } else {
            // ê¸°íƒ€ ì˜ˆì™¸
            errorMsg.textContent = 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          }
        } else {
          // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜
          console.error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ:', err);
          errorMsg.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        }

        errorMsg.style.display='block'
      }
    }

    // ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°/ìˆ¨ê¸°ê¸°
    document.getElementById('toggleBtn').addEventListener('click', ()=>{
      const pw = document.getElementById('password')
      const toggleBtn = document.getElementById('toggleBtn')
      
      if(pw.type === 'password'){
        pw.setAttribute('type', 'text')
        toggleBtn.classList.add('show')
      }else{
        pw.setAttribute('type', 'password')
        toggleBtn.classList.remove('show')
      }
    })
  </script>
</html>