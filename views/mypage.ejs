<!DOCTYPE html>
<html lang="ko">
  <head>
    <%-include('include/head')%>
    <title>title</title>
    <link rel="stylesheet" href="/public/css/mypage.css" />
  </head>
  <body>
    <%- include('include/header') %>
    <!-- <h1>mypage</h1> -->
    <div class="section">
      <div class="change-btn">
        <!-- 찜한 상품 -->
        <div class="wishlist-btn">
          <a href="/wishlist/my">
            <i class="fa-regular fa-heart fa-2x"></i>
          </a>
        </div>
        <button onclick="changeMySection(this)" class="my-btn">
          <i id="img" class="fa-regular fa-user fa-3x"></i>
        </button>
        <button onclick="changeBuySection(this)" class="buy-btn">
          <i class="fa-solid fa-cart-shopping fa-3x"></i>
        </button>
        <button onclick="changeSellSection(this)" class="sell-btn">
          <i class="fas fa-store fa-3x"></i>
        </button>
      </div>
      <form name="userProfile">
        <section class="q profile mypage">
          <!-- insection = img + profileBox -->
          <div id="inSection">
            <div class="profileImg">
              <i id="img" class="fa-regular fa-user fa-7x"></i>
              <div id="name"><strong><%=user.nickname%></strong>님</div>
            </div>
            <!-- profileBox = input + editbtn -->
            <fieldset class="profileBox">
              <legend>회원정보</legend>
              <legend class="le">
                이메일
                <input
                  type="text"
                  name="email"
                  value="<%=user.email%>"
                  readonly
                />
              </legend>
              <legend class="le">
                닉네임
                <input
                  type="text"
                  name="nickname"
                  value="<%=user.nickname%>"
                  readonly
                  required
                />
              </legend>
              <legend class="le">
                새 비밀번호
                <input
                  type="password"
                  id="password"
                  name="password"
                  placeholder="새 비밀번호를 입력하세요"
                  readonly
                  required
                />
              </legend>
              <div id="editbtn">
                <button type="button" onclick="profileEdit();">수정하기</button>
              </div>
            </fieldset>
          </div>
          <div id="logout-btn">
            <a href="/auth/logout"> 로그아웃 </a>
          </div>
        </section>
      </form>

      <!-- 내가 구매한 내역 -->
      <section class="q buy hide">
        <div id="mybuy">내 구매 내역</div>
        <!-- 배열 3개까지 출력-->
        <% if (isSuccess) { %>
        <div class="buyBox">
          <% product.slice(0, 3).forEach(product => { %>
          <div class="myBuy">
            <a class="buyProduct" href="/host/list/<%= product.product_key %>">
              <div id="buypr">
                <img
                  src="/public/img/logo-title.png"
                  alt="<%= product.product.name %>"
                />
              </div>
              <ul>
                <li><strong>상품명:</strong> <%= product.product.name %></li>
                <li><strong>수량:</strong> <%= product.quantity %></li>
                <li>
                  <strong>상품 가격:</strong> <%= product.product.price %>
                </li>
                <li>
                  <strong>Dead-Line:</strong> <%= product.product.deadline %>
                </li>
                <li>
                  <strong>확인:</strong> <%= product.product.product_key %>
                </li>
              </ul>
            </a>
          </div>
          <% }) %>
        </div>
        <% } else { %>
        <p><%= message %></p>
        <% } %>
        <div class="plus">
          <a href="/join">더보기</a>
        </div>
      </section>

      <!-- 내가 주선한 내역 -->
      <section class="q sell hide">
        <div id="mysell">내 주선 내역</div>
        <!-- 배열 3개까지 출력-->
        <% if (isSuccess) { %>
        <div class="sellBox">
          <% product.slice(0, 3).forEach(order => { %>
          <div class="mySell">
            <a
              class="sellProduct"
              href="/host/list/<%= order.product.product_key %>"
            >
              <div id="sellpr">
                <img
                  src="/public/img/logo-title.png"
                  alt="<%= order.product.name %>"
                />
              </div>
              <ul>
                <li>
                  <!-- 구매내역이랑 충돌나는 듯 이름이 같음. 밑에 수량이나 가격은 
                   주선내역이 맞는데 이름 하고 product_key는 구매내역이랑 같음 1시간30분헤멤 
                   이거 product_key가 같으니까 단일 상품 이동 할 때에도 같은 화면으로 넘어가짐
                   mypage에서만 문제고 각자 더보기로 들어가서 단일 상품 들어가면 잘됨
                   되는 부분 : 각 페이지(더보기 들어갔을 때)에서는 잘 나옴, 단일 상품 눌렀을 때에도 데이터 잘 받아짐
                   안되;는 부분 : mypage에서 받아지는 주선내역의 data가 안맞음 안겹치는 
                   max_quantity만 제대로 들어오고 겹치는 항목들은 구매내역이랑 똑같이 나옴
                   mypage에서 단일상품으로 들어가도 주선내역물품인데 구매내역으로 들어가짐 -->
                  <strong>상품명:</strong> <%=order.product.dataValues.name%>
                </li>
                <!-- 내가 구매한 수량, order_item에서 가져옴 -->
                <li><strong>수량:</strong><%=order.product.max_quantity%></li>
                <li><strong>상품 가격:</strong> <%=order.product.price%></li>
                <li><strong>상품명:</strong> <%=order.product.deadline%></li>
                <li><strong>확인:</strong> <%=order.product.product_key%></li>
              </ul>
            </a>
          </div>
          <% }) %>
        </div>
        <% } else { %>
        <p><%= message %></p>
        <% } %>
        <div class="plus">
          <a href="/host/lists">더보기</a>
        </div>
      </section>

      <div class="delete-btn">
        <button type="button" onclick="confirmUserDelete()">
          <i class="fa-solid fa-skull-crossbones fa-2x"></i>
        </button>
      </div>
    </div>
    <%- include('include/footer', { title: '메인 페이지' }) %>
    <script>
      //회원 정보 render & 버튼 수정
      function profileEdit() {
        const form = document.forms['userProfile'];
        const btnBox = document.querySelector('#editbtn');
        console.log(form);
        const nickname = form.nickname;
        const password = form.password;

        nickname.removeAttribute('readonly');
        nickname.setAttribute('placeholder', form.nickname.value);
        nickname.value = '';

        password.removeAttribute('readonly');

        const editBtn = `<button type="button" onclick="editUserProfile()">수정완료</button>`;
        btnBox.innerHTML = editBtn;
      }

      // 회원 정보 수정
      async function editUserProfile() {
        const nickname = document
          .querySelector('input[name="nickname"]')
          .value.trim();
        const password = document
          .querySelector('input[name="password"]')
          .value.trim();

        if (!nickname || !password) {
          alert('닉네임과 비밀번호 둘 다 입력해주세요.');
          return;
        }

        try {
          const response = await axios.put('/user', { nickname, password });

          if (response.data.isSuccess) {
            alert(response.data.message); // 성공 메시지 출력
            location.reload(); // 페이지 새로고침
          } else {
            alert(response.data.message); // 실패 메시지 출력
          }
        } catch (err) {
          console.error('사용자 정보 수정 중 오류:', err);
          alert('최소 1개의 항목을 수정해야 합니다.');
        }
      }

      // 회원 탈퇴
      async function confirmUserDelete() {
        if (confirm('정말 탈퇴하시겠습니까?')) {
          try {
            const response = await axios.delete('/delete'); // 탈퇴 요청 전송
            if (response.status === 200 && response.data.isSuccess) {
              alert('탈퇴가 완료되었습니다. 이용해 주셔서 감사합니다.');
              window.location.href = '/'; // 메인 페이지로 이동
            } else {
              alert('탈퇴에 실패했습니다. 다시 시도해주세요.');
            }
          } catch (err) {
            console.error('회원 탈퇴 중 오류:', err);
            alert('서버 오류가 발생했습니다. 나중에 다시 시도해주세요.');
          }
        }
      }

      // 구매, 판매 내역 조회 칸 보이기
      // 판매 내역 버튼 누르면 my, buy hide
      function changeSellSection(btn) {
        const mypageSection = document.querySelector('.mypage');
        const sellSection = document.querySelector('.sell');
        const buySection = document.querySelector('.buy');
        console.log(mypageSection);
        console.log(sellSection);
        console.log(buySection);
        if (btn.classList.contains('sell-btn')) {
          sellSection.classList.remove('hide');
          mypageSection.classList.add('hide');
          buySection.classList.add('hide');
        }
      }
      // 구매 내역 버튼 누르면 my, sell hide
      function changeBuySection(btn) {
        const mypageSection = document.querySelector('.mypage');
        const sellSection = document.querySelector('.sell');
        const buySection = document.querySelector('.buy');
        console.log(mypageSection);
        console.log(sellSection);
        console.log(buySection);
        if (btn.classList.contains('buy-btn')) {
          buySection.classList.remove('hide');
          sellSection.classList.add('hide');
          mypageSection.classList.add('hide');
        }
      }
      // 마이페이지 버튼 누르면 sell, buy hide
      function changeMySection(btn) {
        const mypageSection = document.querySelector('.mypage');
        const sellSection = document.querySelector('.sell');
        const buySection = document.querySelector('.buy');
        console.log(mypageSection);
        console.log(sellSection);
        console.log(buySection);
        if (btn.classList.contains('my-btn')) {
          mypageSection.classList.remove('hide');
          sellSection.classList.add('hide');
          buySection.classList.add('hide');
        }
      }
    </script>
  </body>
</html>
