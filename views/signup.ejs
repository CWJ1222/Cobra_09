<!DOCTYPE html>
<html lang="ko">
  <head>
    <%-include('include/head')%>
    <title>Signup</title>
    <!-- (todo) ë‚˜ì¤‘ì— Public/css ë¶„ë¦¬ -->
    <style>
      @import url('../public/css/common.css');

      main {
        display: flex;
        justify-content: center;
        flex-direction: column;
        align-items: center;
        padding: 40px 0;
        min-height: 100vh; /* í™”ë©´ ì¤‘ì•™ ìœ„ì¹˜ ì„¤ì • */
      }
      .form-container {
        padding: 1rem;
        width: 100%;
        max-width: 400px;
      }
      #signup-button {
        border: 1px solid var(--color-secondary);
        padding: 10px;
      }
      #signup-button:hover {
        background-color: var(--color-secondary);
      }

      .info-wrapper {
        padding: 1rem;
      }

      #signupForm input {
        margin-bottom: 10px;
        width: 300px;
        height: 42px;
        padding: 12px;
        border: 1px solid var(--color-secondary);
        border-radius: 9px;

        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* ë¹„ë°€ë²ˆí˜¸ ë³´ê¸° ìˆ¨ê¸°ê¸° */
      .passwordInput-wrapper,
      .info-wrapper {
        position: relative;
      }
      .toggleBtn {
        position: absolute;
        cursor: pointer;
        color: var(--color-secondary);
      }
      .pwToggle {
        top: 25%;
        right: 45px;
      }

      .confirmPwToggle {
        top: 30%;
        right: 60px;
      }

      .toggleBtn::before {
        content: '\f070'; /* ëˆˆ ê°ê¹€ */
        font-family: fontAwesome;
      }
      .toggleBtn.show::before {
        content: '\f06e'; /* ëˆˆ ëœ¸! */
        font-family: fontAwesome;
      }

      /* ì—ëŸ¬ ë©”ì‹œì§€ */
      #error {
        display: none;
        width: 320px;
        background-color: #fafafa;
        padding: 20px;
        text-align: start;
        font-size: 14px;
        color: var(--color-error);
        margin-bottom: 20px;
        margin-left: 5px;
      }
      #error::before {
        content: '\f06a'; /* ëŠë‚Œí‘œ */
        font-family: fontAwesome;
        margin-right: 5px;
      }

      /* ê°€ì…í•˜ê¸° ë²„íŠ¼ */
      #signup-button {
        width: 320px;
        background-color: var(--color-primary);
        color: white;
        font-size: 18px;
        font-weight: 600;
        transition: all 0.3x ease;
        margin-left: 5px;
      }
      #signup-button:hover {
        background-color: var(--color-primary-dark);
      }
    </style>
  </head>
  <body>
    <!-- í—¤ë” -->
    <%-include('include/header')%>

    <!-- ë³¸ë¬¸ì˜ì—­ (íšŒì›ê°€ì…) -->
    <main class="max-container">
      <h1>íšŒì›ê°€ì…</h1>
      <br />
      <div class="form-container">
        <form name="signupForm" id="signupForm">
          <!-- ì´ë©”ì¼ ì…ë ¥ -->
          <label for="email">ì´ë©”ì¼</label>
          <div class="info-wrapper">
            <input
              type="email"
              id="email"
              name="email"
              placeholder="ì˜ˆ: example@gmail.com"
              required
            />
          </div>

          <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ -->
          <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
          <div class="info-wrapper">
            <div class="passwordInput-wrapper">
              <input
                type="password"
                id="password"
                name="password"
                placeholder="ë¹„ë°€ë²ˆí˜¸(ì˜ë¬¸+ìˆ«ì+íŠ¹ìˆ˜ë¬¸ì 8ì ì´ìƒ)"
                required
              />
              <span class="toggleBtn pwToggle"></span>
            </div>
          </div>

          <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ -->
          <label for="confirmPassword">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
          <div class="info-wrapper">
            <input
              type="password"
              id="confirm-password"
              name="confirmPassword"
              placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
              required
            />
            <span class="toggleBtn confirmPwToggle"></span>
          </div>

          <!-- ë‹‰ë„¤ì„ ì…ë ¥ (ìë™ìœ¼ë¡œ ì±„ì›Œì§) -->
          <label for="nickname">ë‹‰ë„¤ì„</label>
          <div class="info-wrapper">
            <input
              type="text"
              id="nickname"
              name="nickname"
              placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."
              required
            />
            <div class="error-message" id="nickname-error"></div>
          </div>

          <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
          <div id="error" class="error-message"></div>

          <!-- ê°€ì…í•˜ê¸° ë²„íŠ¼ -->
          <button type="button" id="signup-button">ê°€ì…í•˜ê¸°</button>
        </form>
      </div>
    </main>

    <!-- footer -->
    <%- include('include/footer', { title: 'test' })%>
  </body>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.forms['signupForm'];
      const emailInput = form.email;
      const nicknameInput = form.nickname;
      const passwordInput = form.password;
      const confirmPasswordInput = form.confirmPassword;
      const signupButton = document.getElementById('signup-button');

      // ì—ëŸ¬ ë©”ì‹œì§€ ì˜ì—­ ì´ˆê¸°í™”
      const errorMsg = document.getElementById('error');
      errorMsg.style.display = 'none';
      errorMsg.innerText = '';

      // ì´ë©”ì¼ ì…ë ¥ ì‹œ nickname ìë™ ì„¤ì •
      emailInput.addEventListener('input', () => {
        const email = emailInput.value;
        if (email.includes('@')) {
          const nickname = email.split('@')[0]; // @ ì•ë¶€ë¶„ ê°€ì ¸ì˜¤ê¸°
          nicknameInput.value = nickname;
        }
      });

      // ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
      function checkPassword(pw) {
        // ì˜ë¬¸ + ìˆ«ì + íŠ¹ìˆ˜ë¬¸ì í¬í•¨ 8ì ì´ìƒ
        const pwRegex =
          /^(?=.*[a-zA-Z])(?=.*\d)(?=.*[!@#$%^&*])[A-Za-z\d!@#$%^&*]{8,}$/;
        return pwRegex.test(pw);
      }

      // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬ : example@domain.com
      function checkEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      // íšŒì›ê°€ì… ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      signupButton.addEventListener('click', async () => {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        const confirmPassword = confirmPasswordInput.value.trim();
        const nickname = nicknameInput.value.trim();

        // ì—ëŸ¬ ì´ˆê¸°í™”
        errorMsg.style.display = 'none';
        errorMsg.innerText = '';

        // ìœ íš¨ì„± ê²€ì‚¬
        if (!email || !password || !nickname) {
          errorMsg.style.display = 'block';
          errorMsg.innerText = 'ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸, ë‹‰ë„¤ì„ì€ í•„ìˆ˜ ì…ë ¥ê°’ì…ë‹ˆë‹¤.';
          return;
        }

        if (!checkEmail(email)) {
          errorMsg.style.display = 'block';
          errorMsg.innerText = 'ìœ íš¨í•œ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
          return;
        }

        if (!checkPassword(password)) {
          errorMsg.style.display = 'block';
          errorMsg.innerText =
            'ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
          return;
        }

        if (password !== confirmPassword) {
          errorMsg.style.display = 'block';
          errorMsg.innerText = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          return;
        }

        // ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡
        const data = { email, password, nickname };
        console.log('íšŒì›ê°€ì… ë°ì´í„°', data);

        try {
          // POST /member/signup
          const res = await axios.post('/member/signup', data);

          if (res.data.isSuccess) {
            alert(`${nickname}ë‹˜,` + res.data.message);
            window.location.href = '/auth/login';
          } else {
            errorMsg.style.display = 'block';
            errorMsg.innerText = res.data.message;
          }
        } catch (err) {
          console.error('ğŸš¨íšŒì›ê°€ì… ìš”ì²­ ì¤‘ ì—ëŸ¬ ë°œìƒ:', err);
          errorMsg.style.display = 'block';
          errorMsg.innerText = res.data.message;
        }
      });
    });

    // ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°/ìˆ¨ê¸°ê¸° ì´ë²¤íŠ¸
    document.querySelectorAll('.toggleBtn').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        const pwToggle = btn.classList.contains('pwToggle');
        const targetInput = pwToggle
          ? document.getElementById('password') // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œ
          : document.getElementById('confirm-password'); // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í•„ë“œ

        if (targetInput.type === 'password') {
          targetInput.setAttribute('type', 'text');
          btn.classList.add('show');
        } else {
          targetInput.setAttribute('type', 'password');
          btn.classList.remove('show');
        }
      });
    });
  </script>
</html>
