<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mypage</title>
    <link rel="stylesheet" href="../public/css/mypage.css" />
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <h1>MyPage</h1>
    <form name="userProfile" class="section mypage active">
      <fieldset class="profileBox">
        <legend>회원정보</legend>
        <p>
          이메일:
          <input type="text" name="email" value="<%=user.email%>" readonly />
        </p>
        <p>
          닉네임:
          <input
            type="text"
            name="nickname"
            value="<%=user.nickname%>"
            readonly
          />
        </p>
        <p>
          새 비밀번호:
          <input
            type="password"
            name="password"
            placeholder="비밀번호"
            readonly
          />
        </p>
      </fieldset>
      <div class="btn">
        <button type="button" onclick="profileEdit()">수정하기</button>
        <button type="button" onclick="editUserProfile()" style="display: none">
          수정완료
        </button>
      </div>
      <div class="profile-delete">
        <button type="button" onclick="confirmUserDelete()">회원탈퇴</button>
      </div>
    </form>

    <section class="section buy">
      <h2>공동 구매 상품 구매한 내역</h2>
      <div class="buyBox">
        <% if (isSuccess) { product.forEach(product => { %>
        <div class="myBuy">
          <div class="buyImg">
            <img
              src="<%= product.product.imageUrl || '/default-image.png' %>"
              alt="공구 참여 상품"
            />
          </div>
          <div class="buyDetails">
            <ul>
              <li>상품명: <%= product.product.name %></li>
              <li>수량: <%= product.quantity %></li>
              <li>상품 가격: <%= product.product.price %>원</li>
              <li>
                마감일: <%= new
                Date(product.product.deadline).toLocaleDateString('ko-KR', {
                year: 'numeric', month: '2-digit', day: '2-digit' }) %>
              </li>
            </ul>
          </div>
        </div>
        <hr />
        <% }) } else { %>
        <p><%= message %></p>
        <% } %>
      </div>
      <a href="/join" class="moreLink">더보기</a>
    </section>

    <section class="section sell">
      <h2>공동 구매 판매 등록 내역</h2>
      <div class="sellBox">
        <% if (order && order.length > 0) { %> <% order.forEach((item, index) =>
        { %>
        <div class="mySell">
          <ul>
            <li>번호: <%= index + 1 %></li>
            <li>상품명: <%= item.dataValues.name %></li>
            <li>
              마감일: <%= new
              Date(item.dataValues.deadline).toLocaleDateString('ko-KR', { year:
              'numeric', month: '2-digit', day: '2-digit' }) %>
            </li>
            <li>최대 수량: <%= item.dataValues.max_quantity %></li>
          </ul>
        </div>
        <hr />
        <% }) %> <% } else { %>
        <p>등록된 판매 내역이 없습니다.</p>
        <% } %>
      </div>
    </section>

    <div class="btn-group">
      <button class="my-btn" onclick="changeSection('mypage')">
        마이페이지
      </button>
      <button class="buy-btn" onclick="changeSection('buy')">
        구매 페이지
      </button>
      <button class="sell-btn" onclick="changeSection('sell')">
        판매 페이지
      </button>
    </div>

    <!-- 찜한 상품 -->
    <div class="wishlist-btn">
      <a href="/wishlist/my">찜한 상품</a>
    </div>
  </body>
  <script>
    function changeSection(section) {
      // 모든 섹션 숨기기
      document.querySelectorAll('.section').forEach((el) => {
        el.classList.remove('active');
      });
      // 선택한 섹션만 보이기
      document.querySelector(`.${section}`).classList.add('active');
    }

    function profileEdit() {
      const nickname = document.querySelector('input[name="nickname"]');
      const password = document.querySelector('input[name="password"]');
      const editButton = document.querySelector('.btn button:nth-child(1)');
      const saveButton = document.querySelector('.btn button:nth-child(2)');

      // 닉네임과 비밀번호 필드 활성화
      nickname.removeAttribute('readonly');
      password.removeAttribute('readonly');

      // 버튼 전환
      editButton.style.display = 'none';
      saveButton.style.display = 'inline-block';

      alert('닉네임과 비밀번호를 수정할 수 있습니다.');
    }

    // 회원 정보 수정 -> 수정!
    async function editUserProfile() {
      const nickname = document
        .querySelector('input[name="nickname"]')
        .value.trim();
      const password = document
        .querySelector('input[name="password"]')
        .value.trim();

      console.log(nickname);
      console.log(password);

      if (!nickname || !password) {
        alert('닉네임과 변경할 비밀번호 모두 입력해주세요.');
        return;
      }

      try {
        const response = await axios.put('/user', { nickname, password });

        if (response.data.isSuccess) {
          alert(response.data.message); // 성공 메시지 출력
          location.reload(); // 페이지 새로고침
        } else {
          alert(response.data.message); // 실패 메시지 출력
        }
      } catch (err) {
        console.error('사용자 정보 수정 중 오류:', err);
      }
    }

    async function confirmUserDelete() {
      if (confirm('정말 탈퇴하시겠습니까?')) {
        try {
          const response = await axios.delete('/delete'); // 탈퇴 요청 전송
          if (response.status === 200 && response.data.isSuccess) {
            alert('탈퇴가 완료되었습니다. 이용해 주셔서 감사합니다.');
            window.location.href = '/'; // 메인 페이지로 이동
          } else {
            alert('탈퇴에 실패했습니다. 다시 시도해주세요.');
          }
        } catch (err) {
          console.error('회원 탈퇴 중 오류:', err);
          alert('서버 오류가 발생했습니다. 나중에 다시 시도해주세요.');
        }
      }
    }
  </script>
</html>
